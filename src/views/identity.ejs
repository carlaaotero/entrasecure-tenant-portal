<!DOCTYPE html>
<html lang="ca">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>
    <%= title %>
  </title>

  <!-- Design foundation -->
  <link rel="stylesheet" href="/css/foundation.css" />
  <!-- Utilities -->
  <link rel="stylesheet" href="/css/utilities.css" />

  <!-- Components -->
  <link rel="stylesheet" href="/css/components/navbar.css" />
  <link rel="stylesheet" href="/css/components/button.css" />
  <link rel="stylesheet" href="/css/components/card.css" />
  <link rel="stylesheet" href="/css/components/avatar.css" />
  <link rel="stylesheet" href="/css/components/confirmModal.css" />


  <!-- Page-specific -->
  <link rel="stylesheet" href="/css/pages/identity.css" />
</head>

<body>
  <!-- Navbar -->
  <%- include('components/navbar', { active: 'me' }) %>


    <main class="identity-main">
    <section class="identity-layout">

      <% if (flash && flash.message) { %>
  <div class="card" style="margin: 12px 0; padding: 12px;">
    <strong>
      <%= flash.type==='error' ? 'Error' : (flash.type==='success' ? 'OK' : 'Info') %>:
    </strong>
    <span><%= flash.message %></span>
  </div>
<% } %>


      <!-- Perfil: columna esquerra, ocupant les 3 primeres files -->
      <article class="card identity-profile-card">
        <div class="identity-avatar-wrapper">
          <div class="profile-avatar">
            <span>
              <% 
                const displayName = userProfile && userProfile.displayName ? userProfile.displayName : (user && (user.name || user.username));
                const initial = displayName ? displayName.charAt(0).toUpperCase() : 'U';
              %>
              <%= initial %>
            </span>
          </div>
        </div>

        <div class="identity-profile-info">
          <h2 class="identity-title">
            <%= userProfile && userProfile.displayName ? userProfile.displayName : 'Usuari autenticat' %>
          </h2>
          <p class="identity-upn">
            <%= userProfile && userProfile.userPrincipalName ? userProfile.userPrincipalName : (user && user.username) || '' %>
          </p>
        </div>

        <dl class="identity-details">
          <div class="identity-detail-row">
            <dt>Display Name</dt>
            <dd><%= userProfile && userProfile.displayName || '—' %></dd>
          </div>

          <div class="identity-detail-row">
            <dt>User Principal Name</dt>
            <dd><%= userProfile && userProfile.userPrincipalName || '—' %></dd>
          </div>

          <div class="identity-detail-row">
            <dt>User Type</dt>
            <dd><%= userProfile && userProfile.userType || '—' %></dd>
          </div>

          <div class="identity-detail-row">
            <dt>Created date time</dt>
            <dd><%= userProfile && userProfile.createdDateTime || '—' %></dd>
          </div>

          <div class="identity-detail-row">
            <dt>Mail nickname</dt>
            <dd><%= userProfile && userProfile.mailNickname || '—' %></dd>
          </div>

          <div class="identity-detail-row">
            <dt>Last password change date time</dt>
            <dd>
              <% if (userProfile && userProfile.lastPasswordChangeDateTime) { %>
                <%= userProfile.lastPasswordChangeDateTime %>
              <% } else { %>
                N/A
              <% } %>
            </dd>
          </div>
        </dl>
      </article>

      <!-- Groups: columna dreta, fila 1 -->
      <article class="card identity-card identity-groups-card">
        <h3>Groups</h3>
        <div class="identity-card-content">
          <% if (groups && groups.length > 0) { %>
            <div class="identity-item-list">
              <% groups.forEach(function (g) { %>
                <div class="identity-item-card">
                  <div class="identity-item-title">
                    <%= g.displayName || '(Sense nom)' %>
                  </div>
                  <div class="identity-item-meta">
                    ID: <%= g.id %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <p class="identity-empty">No hi ha grups associats o no es poden llegir.</p>
          <% } %>
        </div>
      </article>

      <!-- Directory Roles: columna dreta, fila 2 -->
      <article class="card identity-card identity-roles-card">
        <h3>Directory Roles</h3>
        <div class="identity-card-content">
          <% if (roles && roles.length > 0) { %>
            <div class="identity-item-list">
              <% roles.forEach(function (r) { %>
                <div class="identity-item-card">
                  <div class="identity-item-title">
                    <%= r.displayName || '(Sense nom)' %>
                  </div>
                  <div class="identity-item-meta">
                    ID: <%= r.id %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <p class="identity-empty">Aquest usuari no té rols de directori assignats (o no es poden llegir).</p>
          <% } %>
        </div>
      </article>

      <!-- Applications: columna dreta, fila 3 -->
      <article class="card identity-card identity-apps-card">
        <h3>Applications (App Role Assignments)</h3>
        <div class="identity-card-content">
          <% if (apps && apps.length > 0) { %>
            <div class="identity-item-list">
              <% apps.forEach(function (a) { %>
                <div class="identity-item-card">
                  <div class="identity-item-title">
                    <%= a.resourceDisplayName || '(Aplicació sense nom)' %>
                  </div>
                  <div class="identity-item-meta">
                    App Role ID: <%= a.appRoleId %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <p class="identity-empty">No s'han trobat aplicacions amb rols assignats.</p>
          <% } %>
        </div>
      </article>

      <!-- Devices: columna dreta, fila 4 -->
      <article class="card identity-card identity-devices-card">
        <h3>Devices</h3>
        <div class="identity-card-content">
          <% if (devices && devices.length > 0) { %>
            <div class="identity-item-list">
              <% devices.forEach(function (d) { %>
                <div class="identity-item-card">
                  <div class="identity-item-title">
                    <%= d.displayName || '(Device sense nom)' %>
                  </div>
                  <div class="identity-item-meta">
                    Type: <%= d['@odata.type'] || '—' %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <p class="identity-empty">No hi ha dispositius registrats per aquest usuari.</p>
          <% } %>
        </div>
      </article>

      <!-- Card educativa: columna esquerra, fila 4 (alineada amb Devices) -->
      <article class="card identity-card identity-edu-card">
        <h3>Com llegir aquesta informació</h3>
        <div class="identity-card-content">
          <p class="identity-edu">
            <%= helpfulInfo %>
          </p>
        </div>
      </article>

    </section>
  </main>

<!-- Modal global -->
<%- include('components/confirmModal', {
  title: 'Confirmació',
  message: 'Segur que vols continuar?',
  okText: 'Acceptar',
  cancelText: 'Cancel·lar'
}) %>

<script src="/js/confirmModal.js"></script>
<script src="/js/navbar.js"></script>



  <footer class="footer">
    <small>&copy; <%= new Date().getFullYear() %> EntraSecure · TFG</small>
  </footer>
</body>

</html>