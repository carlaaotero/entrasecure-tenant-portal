<!DOCTYPE html>
<html lang="ca">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>
    <%= title %>
  </title>

  <!-- Design foundation -->
  <link rel="stylesheet" href="/css/foundation.css" />
  <!-- Utilities -->
  <link rel="stylesheet" href="/css/utilities.css" />

  <!-- Components -->
  <link rel="stylesheet" href="/css/components/navbar.css" />
  <link rel="stylesheet" href="/css/components/button.css" />
  <link rel="stylesheet" href="/css/components/card.css" />
  <link rel="stylesheet" href="/css/components/avatar.css" />

  <!-- Mateix layout que My Identity -->
  <link rel="stylesheet" href="/css/pages/identity.css" />
  <!-- Reutilitzem estils del selector d'usuaris (dropdown + chips) -->
  <link rel="stylesheet" href="/css/pages/tenantUsers.css" />

</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      <div class="brand">EntraSecure Tenant Portal</div>
      <ul class="nav-links">
        <li><a href="/" class="nav-link">Home</a></li>
        <% if (user) { %>
          <li><a href="/me" class="nav-link">My Identity</a></li>
          <li><a href="/tenant" class="nav-link nav-link-active">Tenant Explorer</a></li>
          <li><a href="/security" class="nav-link">Security</a></li>
          <% } %>
      </ul>
    </div>

    <div class="navbar-right">
      <% if (user) { %>
        <div class="user-pill">
          <span class="user-initial">
            <% const navName=user.name || user.username || 'U' ; const navInitial=navName.charAt(0).toUpperCase(); %>
              <%= navInitial %>
          </span>

          <span class="user-name">
            <%= user.name || user.username || 'Usuari' %>
          </span>
        </div>
        <% } else { %>
          <a href="/auth/login" class="btn btn-outline-light">Login</a>
          <% } %>
    </div>
  </nav>

  <main class="identity-main">
    <section class="identity-layout">

      <!-- Perfil del grup (mateix estil que My Identity) -->
      <article class="card identity-profile-card">
        <div class="identity-avatar-wrapper">
          <div class="profile-avatar">
            <span>
              <% const gName=groupProfile && groupProfile.displayName ? groupProfile.displayName : 'Grup' ; const
                gInitial=gName.charAt(0).toUpperCase(); %>
                <%= gInitial %>
            </span>
          </div>
        </div>

        <div class="identity-profile-info">
          <h2 class="identity-title">
            <%= groupProfile && groupProfile.displayName ? groupProfile.displayName : 'Grup del tenant' %>
          </h2>
        </div>

        <% const gTypes=groupProfile && groupProfile.groupTypes || []; const isM365=gTypes.includes('Unified'); const
          groupTypeLabel=isM365 ? 'Microsoft 365' : 'Security' ; const groupSourceLabel=groupProfile &&
          groupProfile.onPremisesSyncEnabled ? 'Synced (AD)' : 'Cloud' ; %>

          <!-- Detalls del grup -->
          <dl class="identity-details">
            <div class="identity-detail-row">
              <dt>Group name</dt>
              <dd>
                <%= groupProfile && groupProfile.displayName || '—' %>
              </dd>
            </div>

            <div class="identity-detail-row">
              <dt>Group description</dt>
              <dd>
                <%= groupProfile && groupProfile.description || '—' %>
              </dd>
            </div>

            <div class="identity-detail-row">
              <dt>Group source</dt>
              <dd>
                <%= groupSourceLabel %>
              </dd>
            </div>

            <div class="identity-detail-row">
              <dt>Group type</dt>
              <dd>
                <%= groupTypeLabel %>
              </dd>
            </div>

            <div class="identity-detail-row">
              <dt>Created date time</dt>
              <dd>
                <% if (groupProfile && groupProfile.createdDateTime) { %>
                  <%= groupProfile.createdDateTime %>
                    <% } else { %>
                      —
                      <% } %>
              </dd>
            </div>
          </dl>
      </article>

      <!-- Members: selector + llista -->
      <article class="card identity-card identity-groups-card">
        <h3>Members</h3>
        <div class="identity-card-content">

          <!-- Formulari per afegir membres al grup amb desplegable -->
          <form id="addMembersForm" method="POST"
            action="/tenant/groups/<%= encodeURIComponent(groupProfile.id) %>/members/add" class="identity-inline-form">
            <label for="groupMembersInput" class="identity-inline-label">
              Afegir membres al grup
            </label>

            <div class="identity-inline-input">
              <input id="groupMembersInput" type="text" class="users-input"
                placeholder="Cerca per nom o UPN, o escriu un UPN i prem Enter" autocomplete="off" />

              <!-- Dropdown amb usuaris (com a la creació de grups) -->
              <div id="membersDropdown" class="owners-dropdown" style="display:none;"></div>
            </div>

            <small class="field-hint">
              Pots seleccionar usuaris amb el desplegable o escriure UPNs manualment (separats per comes o Enter).
            </small>


            <!-- Chips amb els membres que afegiràs -->
            <div id="membersChips" class="owners-chip-list"></div>

            <!-- Hidden amb els UPNs/IDs que s'enviaran al backend -->
            <input type="hidden" name="memberKeys" id="membersHidden" />

            <div class="identity-inline-actions">
              <button type="submit" class="btn btn-primary btn-sm">
                Afegir membres seleccionats
              </button>
            </div>
          </form>

          <% if (members && members.length> 0) { %>
            <div class="identity-item-list">
              <% members.forEach(function (m) { %>
                <div class="identity-item-card identity-removable">

                  <!-- BOTÓ ELIMINAR (creu) -->
                  <form method="POST"
                    action="/tenant/groups/<%= encodeURIComponent(groupProfile.id) %>/members/<%= encodeURIComponent(m.id) %>/remove"
                    onsubmit="return confirm('Vols eliminar «<%= m.displayName || m.userPrincipalName %>» del grup?');"
                    class="remove-form">
                    <button type="submit" class="remove-btn">×</button>
                  </form>

                  <!-- INFO DEL MEMBER -->
                  <div class="identity-item-title">
                    <a href="/tenant/users/<%= encodeURIComponent(m.id) %>" class="identity-link">
                      <%= m.displayName || m.userPrincipalName || '(Sense nom)' %>
                    </a>
                  </div>
                  <div class="identity-item-meta">
                    <%= m.userPrincipalName || '' %><br />
                      <%= m.userType || '—' %>
                        <% if (typeof m.accountEnabled==='boolean' ) { %>
                          · <%= m.accountEnabled ? 'Enabled' : 'Disabled' %>
                            <% } %>
                  </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>

              <p class="identity-empty">
                Aquest grup no té membres o no es pot llegir la informació.
              </p>
              <% } %>
        </div>
      </article>



      <!-- Owners: selector + llista -->
      <article class="card identity-card identity-roles-card">
        <h3>Owners</h3>
        <div class="identity-card-content">

          <!-- Formulari per afegir owners amb desplegable -->
          <form id="addOwnersForm" method="POST"
            action="/tenant/groups/<%= encodeURIComponent(groupProfile.id) %>/owners/add" class="identity-inline-form">
            <label for="groupOwnersInput" class="identity-inline-label">
              Afegir owners al grup
            </label>
            <div class="identity-inline-input">
              <input id="groupOwnersInput" type="text" class="users-input"
                placeholder="Cerca per nom o UPN, o escriu un UPN i prem Enter" autocomplete="off" />

              <!-- Dropdown amb usuaris -->
              <div id="ownersDropdown" class="owners-dropdown" style="display:none;"></div>
            </div>

            <small class="field-hint">
              Selecciona usuaris amb el desplegable o escriu UPNs manualment.
            </small>


            <!-- Chips amb els owners que afegiràs -->
            <div id="ownersChips" class="owners-chip-list"></div>

            <!-- Hidden amb els UPNs/IDs que s'enviaran al backend -->
            <input type="hidden" name="ownerKeys" id="ownersHidden" />

            <div class="identity-inline-actions">
              <button type="submit" class="btn btn-primary btn-sm">
                Afegir owners seleccionats
              </button>
            </div>
          </form>

          <% if (owners && owners.length> 0) { %>
            <div class="identity-item-list">
              <% owners.forEach(function (o) { %>
                <div class="identity-item-card identity-removable">

                  <!-- BOTÓ ELIMINAR (creu) -->
                  <form method="POST"
                    action="/tenant/groups/<%= encodeURIComponent(groupProfile.id) %>/owners/<%= encodeURIComponent(o.id) %>/remove"
                    onsubmit="return confirm('Vols eliminar «<%= o.displayName || o.userPrincipalName %>» com a owner del grup?');"
                    class="remove-form">
                    <button type="submit" class="remove-btn">×</button>
                  </form>

                  <!-- INFO DE L'OWNER -->
                  <div class="identity-item-title">
                    <a href="/tenant/users/<%= encodeURIComponent(o.id) %>" class="identity-link">
                      <%= o.displayName || o.userPrincipalName || '(Sense nom)' %>
                    </a>
                  </div>
                  <div class="identity-item-meta">
                    <%= o.userPrincipalName || '' %><br />
                      <%= o.userType || '—' %>
                  </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>

              <p class="identity-empty">
                Aquest grup no té owners o no es pot llegir la informació.
              </p>
              <% } %>
        </div>
      </article>



      <!-- Directory Roles -->
      <article class="card identity-card identity-apps-card">
        <h3>Directory Roles</h3>
        <div class="identity-card-content">
          <% if (directoryRoles && directoryRoles.length> 0) { %>
            <div class="identity-item-list">
              <% directoryRoles.forEach(function (r) { %>
                <div class="identity-item-card">
                  <div class="identity-item-title">
                    <%= r.displayName || '(Sense nom)' %>
                  </div>
                  <div class="identity-item-meta">
                    ID: <%= r.id %>
                  </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>
              <p class="identity-empty">
                Aquest grup no forma part de cap directory role assignable o no es pot llegir la informació.
              </p>
              <% } %>
        </div>
      </article>

      <!-- Applications (App Role Assignments) -->
      <article class="card identity-card identity-devices-card">
        <h3>Applications</h3>
        <div class="identity-card-content">
          <% if (appAssignments && appAssignments.length> 0) { %>
            <div class="identity-item-list">
              <% appAssignments.forEach(function (a) { %>
                <div class="identity-item-card">
                  <div class="identity-item-title">
                    <%= a.resourceDisplayName || '(Aplicació sense nom)' %>
                  </div>
                  <div class="identity-item-meta">
                    App Role ID: <%= a.appRoleId || '—' %>
                  </div>
                </div>
                <% }); %>
            </div>
            <% } else { %>
              <p class="identity-empty">
                No hi ha app role assignments per aquest grup o no es pot llegir la informació.
              </p>
              <% } %>
        </div>
      </article>

      <!-- Targeta explicativa -->
      <article class="card identity-edu-card">
        <h3 class="identity-edu-title">Com llegir aquesta informació</h3>
        <p class="identity-edu">
          <%= helpfulInfo %>
        </p>
      </article>

    </section>
  </main>

  <footer class="footer">
    <small>&copy; <%= new Date().getFullYear() %> EntraSecure · TFG</small>
  </footer>
  <script>
    (function () {
      // Usuaris del tenant injectats des del servidor
      const allUsers = <%- JSON.stringify(users || []) %>;

      // Helper comú per muntar un selector amb desplegable + chips
      function setupUserSelector(config) {
        const {
          inputId,
          dropdownId,
          chipsId,
          hiddenId,
        } = config;

        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        const chips = document.getElementById(chipsId);
        const hidden = document.getElementById(hiddenId);

        const selected = [];

        function updateHidden() {
          if (hidden) {
            hidden.value = selected.join(',');
          }
        }

        function renderChips() {
          if (!chips) return;
          chips.innerHTML = '';

          selected.forEach((upn, index) => {
            const chip = document.createElement('span');
            chip.className = 'owner-chip';
            chip.textContent = upn + ' ';

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'owner-chip-remove';
            closeBtn.textContent = '×';

            closeBtn.addEventListener('click', () => {
              selected.splice(index, 1);
              updateHidden();
              renderChips();
            });

            chip.appendChild(closeBtn);
            chips.appendChild(chip);
          });
        }

        function buildDropdown() {
          if (!dropdown) return;

          dropdown.innerHTML = '';

          // Header: cerca + botó afegir
          const header = document.createElement('div');
          header.className = 'owners-dropdown-header';

          const searchBox = document.createElement('input');
          searchBox.type = 'text';
          searchBox.placeholder = 'Cerca per nom o UPN';
          searchBox.className = 'users-input owners-search-input';

          const addBtn = document.createElement('button');
          addBtn.type = 'button';
          addBtn.textContent = 'Afegir seleccionats';
          addBtn.className = 'btn btn-primary owners-add-btn';

          header.appendChild(searchBox);
          header.appendChild(addBtn);

          // Llista amb scroll
          const list = document.createElement('div');
          list.className = 'owners-dropdown-list';

          dropdown.appendChild(header);
          dropdown.appendChild(list);

          function renderList(filterTerm = '') {
            const term = (filterTerm || '').trim().toLowerCase();
            list.innerHTML = '';

            const filtered = (allUsers || []).filter(u => {
              const dn = (u.displayName || '').toLowerCase();
              const upn = (u.userPrincipalName || '').toLowerCase();
              if (!term) return true;
              return dn.includes(term) || upn.includes(term);
            });

            filtered.forEach(u => {
              const option = document.createElement('label');
              option.className = 'owner-option';

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.className = 'owner-option-checkbox';
              checkbox.value = u.userPrincipalName || '';

              const info = document.createElement('div');
              info.className = 'owner-option-info';
              info.innerHTML = `
                <span class="owner-option-name">${u.displayName || '(Sense nom)'}</span>
                <span class="owner-option-upn">${u.userPrincipalName || ''}</span>
                <span class="owner-option-type">${u.userType || ''}</span>
              `;

              option.appendChild(checkbox);
              option.appendChild(info);
              list.appendChild(option);
            });
          }

          renderList('');

          // Filtrat en temps real
          searchBox.addEventListener('input', (e) => {
            renderList(e.target.value || '');
          });

          // Afegir seleccionats a l'array + chips
          addBtn.addEventListener('click', () => {
            const checked = list.querySelectorAll('.owner-option-checkbox:checked');

            checked.forEach(cb => {
              const upn = cb.value;
              if (upn && !selected.includes(upn)) {
                selected.push(upn);
              }
            });

            updateHidden();
            renderChips();

            // netegem selecció
            checked.forEach(cb => {
              cb.checked = false;
            });
          });
        }

        // Obrir/tancar desplegable
        if (input && dropdown) {
          input.addEventListener('focus', () => {
            if (!dropdown.hasChildNodes()) {
              buildDropdown();
            }
            dropdown.style.display = 'block';
          });

          document.addEventListener('click', (e) => {
            if (input.contains(e.target) || dropdown.contains(e.target)) {
              return;
            }
            dropdown.style.display = 'none';
          });
        }

        // Afegir UPN manualment amb Enter
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              const value = input.value.trim();
              if (!value) return;

              // permetré múltiples UPN separats per comes en un sol Enter
              value.split(',')
                .map(v => v.trim())
                .filter(Boolean)
                .forEach(v => {
                  if (!selected.includes(v)) {
                    selected.push(v);
                  }
                });

              updateHidden();
              renderChips();
              input.value = '';
            }
          });
        }

        // Exposem una funció per “buida” l'input en el submit
        function flushInput() {
          if (!input) return;
          const value = input.value.trim();
          if (!value) return;

          value.split(',')
            .map(v => v.trim())
            .filter(Boolean)
            .forEach(v => {
              if (!selected.includes(v)) {
                selected.push(v);
              }
            });

          updateHidden();
          renderChips();
          input.value = '';
        }

        return {
          flushInput,
        };
      }

      // --- Instanciem els dos selectors: Members i Owners ---

      const membersSelector = setupUserSelector({
        inputId: 'groupMembersInput',
        dropdownId: 'membersDropdown',
        chipsId: 'membersChips',
        hiddenId: 'membersHidden',
      });

      const ownersSelector = setupUserSelector({
        inputId: 'groupOwnersInput',
        dropdownId: 'ownersDropdown',
        chipsId: 'ownersChips',
        hiddenId: 'ownersHidden',
      });

      // Integrar amb els formularis existents
      const addMembersForm = document.getElementById('addMembersForm');
      const addOwnersForm = document.getElementById('addOwnersForm');

      if (addMembersForm && membersSelector) {
        addMembersForm.addEventListener('submit', () => {
          membersSelector.flushInput();
        });
      }

      if (addOwnersForm && ownersSelector) {
        addOwnersForm.addEventListener('submit', () => {
          ownersSelector.flushInput();
        });
      }
    })();
  </script>


</body>

</html>