<!DOCTYPE html>
<html lang="ca">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>
    <%= title %> · EntraSecure
  </title>

  <!-- Design foundation -->
  <link rel="stylesheet" href="/css/foundation.css" />
  <!-- Utilities -->
  <link rel="stylesheet" href="/css/utilities.css" />

  <!-- Components -->
  <link rel="stylesheet" href="/css/components/navbar.css" />
  <link rel="stylesheet" href="/css/components/button.css" />
  <link rel="stylesheet" href="/css/components/card.css" />
  <link rel="stylesheet" href="/css/components/avatar.css" />

  <!-- De moment reutilitzem els estils de la pàgina d'usuaris -->
  <link rel="stylesheet" href="/css/pages/tenantUsers.css" />
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-left">
      <div class="brand">EntraSecure Tenant Portal</div>
      <ul class="nav-links">
        <li><a href="/" class="nav-link">Home</a></li>
        <% if (user) { %>
          <li><a href="/me" class="nav-link">My Identity</a></li>
          <li><a href="/tenant" class="nav-link nav-link-active">Tenant Explorer</a></li>
          <li><a href="/security" class="nav-link">Security</a></li>
        <% } %>
      </ul>
    </div>

    <div class="navbar-right">
      <% if (user) { %>
        <div class="user-pill">
          <span class="user-initial">
            <% if (user.name) { %>
              <%= user.name.charAt(0).toUpperCase() %>
            <% } else if (user.username) { %>
              <%= user.username.charAt(0).toUpperCase() %>
            <% } else { %>U<% } %>
          </span>

          <span class="user-name">
            <%= user.name || user.username || 'Usuari' %>
          </span>
        </div>
      <% } else { %>
        <a href="/auth/login" class="btn btn-outline-light">Login</a>
      <% } %>
    </div>
  </nav>

  <main class="tenant-users-main">
    <section class="tenant-users-layout">
      <header class="users-header">
        <h1>Grups del tenant</h1>
        <p>
          Llista de grups de Microsoft Entra ID (Security, Microsoft 365, etc.)
          amb el seu nom, tipus principal i origen.
        </p>
      </header>

      <!-- CARD / CREAR NOU GRUP -->
      <article class="card users-card create-user-card">
        <div class="users-card-header">
          <div class="users-header-left">
            <h2>Crear un grup nou</h2>
            <p class="users-meta">
              Dona d'alta un grup de seguretat o Microsoft 365 al tenant.
            </p>
          </div>
        </div>

        <form method="POST" action="/tenant/groups/create" class="create-user-form">
          <div class="users-card-body create-user-body">

            <div class="create-user-grid">
              <!-- Columna esquerra -->
              <div class="create-user-col">
                <div class="form-group">
                  <label for="newGroupDisplayName">Group name</label>
                  <input
                    id="newGroupDisplayName"
                    type="text"
                    name="displayName"
                    required
                    class="users-input"
                    autocomplete="off"
                  />
                </div>

                <div class="form-group">
                  <label for="newGroupDescription">Group description</label>
                  <textarea
                    id="newGroupDescription"
                    name="description"
                    rows="3"
                    class="users-input"
                  ></textarea>
                </div>
              </div>

              <!-- Columna dreta -->
              <div class="create-user-col">
                <div class="form-group">
                  <label for="newGroupType">Group type</label>
                  <select
                    id="newGroupType"
                    name="groupType"
                    class="users-input"
                    required
                  >
                    <option value="security">Security</option>
                    <option value="m365">Microsoft 365</option>
                  </select>
                  <small class="field-hint">
                    Security: grup per permisos. Microsoft 365: correu, Teams, etc.
                  </small>
                </div>

                <p class="field-hint">
                  El grup es crearà com a <strong>Cloud</strong>. Els grups sincronitzats
                  des d'Active Directory no es poden crear des del portal.
                </p>
              </div>
            </div>

            <div class="create-user-actions">
              <button type="submit" class="btn btn-primary">
                Crear grup
              </button>
            </div>
          </div>
        </form>
      </article>

      <!-- Formulari per eliminar grups seleccionats -->
      <form method="POST" action="/tenant/groups/delete"
        onsubmit="return confirm('Vols eliminar els grups seleccionats del tenant? Aquesta acció és irreversible.');">

        <article class="card users-card">
          <div class="users-card-header">
            <div class="users-header-left">
              <h2>Llista de grups</h2>
              <p class="users-meta">
                <span class="users-meta-count">
                  <%= groups && groups.length ? groups.length : 0 %>
                </span> grups trobats
              </p>
            </div>

            <div class="users-header-right">
              <div class="users-filters">
                <input id="groupSearch" type="text" class="users-search-input"
                  placeholder="Cerca per nom"
                  onkeydown="if (event.key === 'Enter') { event.preventDefault(); }" />

                <select id="groupTypeFilter" class="users-type-filter">
                  <option value="all">Tots els tipus</option>
                  <option value="security">Security</option>
                  <option value="m365">Microsoft 365</option>
                </select>

                <select id="groupSourceFilter" class="users-type-filter">
                  <option value="all">Tots els orígens</option>
                  <option value="cloud">Cloud</option>
                  <option value="synced">Synced (AD)</option>
                </select>
              </div>

              <button type="submit" class="btn btn-primary">
                Eliminar seleccionats
              </button>
            </div>
          </div>

          <div class="users-card-body">
            <% if (groups && groups.length > 0) { %>
              <table class="users-table">
                <thead>
                  <tr>
                    <th>Group name</th>
                    <th>Group type</th>
                    <th>Source</th>
                    <th>Seleccionar</th>
                  </tr>
                </thead>
                <tbody>
                  <% groups.forEach(function (g) { 
                      const types = g.groupTypes || [];
                      const isM365 = types.includes('Unified');

                      const typeLabel = isM365 ? 'Microsoft 365' : 'Security';
                      const typeValue = isM365 ? 'm365' : 'security';

                      const sourceLabel = g.onPremisesSyncEnabled ? 'Synced (AD)' : 'Cloud';
                  %>
                    <tr
                      data-display-name="<%= g.displayName || '' %>"
                      data-type="<%= typeValue %>"
                      data-source="<%= sourceLabel.toLowerCase().includes('synced') ? 'synced' : 'cloud' %>"
                    >
                      <td>
                        <a href="/tenant/groups/<%= encodeURIComponent(g.id) %>" class="users-link">
                          <%= g.displayName || '(Sense nom)' %>
                        </a>
                      </td>
                      <td>
                        <%= typeLabel %>
                      </td>
                      <td>
                        <%= sourceLabel %>
                      </td>
                      <td class="users-select-cell">
                        <input type="checkbox" name="groupIds" value="<%= g.id %>" />
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            <% } else { %>
              <p class="users-empty">
                No s'ha trobat cap grup o no es pot llegir la informació.
              </p>
            <% } %>
          </div>
        </article>
      </form>
    </section>
  </main>

  <footer class="footer">
    <small>&copy; <%= new Date().getFullYear() %> EntraSecure · TFG</small>
  </footer>

  <!-- JS: filtres per la taula de grups -->
  <script>
    (function () {
      const searchInput = document.getElementById('groupSearch');
      const typeFilter = document.getElementById('groupTypeFilter');
      const sourceFilter = document.getElementById('groupSourceFilter');
      const rows = Array.from(document.querySelectorAll('.users-table tbody tr'));
      const countSpan = document.querySelector('.users-meta-count');

      function applyGroupFilters() {
        const term = (searchInput && searchInput.value || '').trim().toLowerCase();
        const type = (typeFilter && typeFilter.value || 'all').toLowerCase();
        const source = (sourceFilter && sourceFilter.value || 'all').toLowerCase();

        let visibleCount = 0;

        rows.forEach(row => {
          const dn = (row.dataset.displayName || '').toLowerCase();
          const groupType = (row.dataset.type || '').toLowerCase();   // 'security' o 'm365'
          const groupSource = (row.dataset.source || '').toLowerCase(); // 'cloud' o 'synced'

          const matchesText =
            !term || dn.includes(term);

          const matchesType =
            type === 'all' || groupType === type;

          const matchesSource =
            source === 'all' || groupSource === source;

          const visible = matchesText && matchesType && matchesSource;

          row.style.display = visible ? '' : 'none';

          if (visible) visibleCount++;
        });

        if (countSpan) countSpan.textContent = visibleCount;
      }

      if (searchInput) searchInput.addEventListener('input', applyGroupFilters);
      if (typeFilter) typeFilter.addEventListener('change', applyGroupFilters);
      if (sourceFilter) sourceFilter.addEventListener('change', applyGroupFilters);

      // Estat inicial
      applyGroupFilters();
    })();
  </script>
</body>

</html>
