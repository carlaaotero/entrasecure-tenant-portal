<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>
        <%= title %> · EntraSecure
    </title>

    <!-- Design foundation -->
    <link rel="stylesheet" href="/css/foundation.css" />
    <!-- Utilities -->
    <link rel="stylesheet" href="/css/utilities.css" />

    <!-- Components -->
    <link rel="stylesheet" href="/css/components/navbar.css" />
    <link rel="stylesheet" href="/css/components/button.css" />
    <link rel="stylesheet" href="/css/components/card.css" />
    <link rel="stylesheet" href="/css/components/avatar.css" />
    <link rel="stylesheet" href="/css/components/confirmModal.css" />
    <link rel="stylesheet" href="/css/components/navigation.css" />

    <!-- Page-specific -->
    <link rel="stylesheet" href="/css/pages/tenantUsers.css" />
</head>

<body>
    <!-- Navbar -->
    <%- include('../components/navbar', { active: 'tenant' }) %>

        <main class="tenant-users-main">
            <a href="/tenant" class="back-arrow" aria-label="Tornar a Tenant Explorer">
                ←
            </a>
            <section class="tenant-users-layout">

                <header class="users-header">
                    <h1>Tenant users</h1>
                    <p>
                        List of Microsoft Entra ID users with basic information: Display Name, UPN, user type, and
                        account status.
                    </p>
                </header>

                <% if (flash && flash.message) { %>
                    <div class="card" style="margin: 12px 0; padding: 12px;">
                        <strong>
                            <%= flash.type==='error' ? 'Error' : (flash.type==='success' ? 'OK' : 'Info' ) %>:
                        </strong>
                        <span>
                            <%= flash.message %>
                        </span>
                    </div>
                    <% } %>


                        <!-- CARD / CREAR NOU USUARI -->
                        <article class="card users-card create-user-card">
                            <div class="users-card-header">
                                <div class="users-header-left">
                                    <h2>Create a new user</h2>
                                    <p class="users-meta">
                                        Create a new Member user with a secure initial password.
                                    </p>
                                </div>
                            </div>

                            <form id="createUserForm" method="POST" action="/tenant/users/create"
                                class="create-user-form">

                                <div class="users-card-body create-user-body">

                                    <div class="create-user-grid">
                                        <!-- Columna esquerra -->
                                        <div class="create-user-col">
                                            <div class="form-group">
                                                <label for="newDisplayName">Full name (Display Name)</label>
                                                <input id="newDisplayName" type="text" name="displayName" required
                                                    class="users-input" autocomplete="off" />
                                                <small id="displayNameError" class="field-hint"></small>
                                            </div>

                                            <div class="form-group">
                                                <label for="newUserPrincipalName">User Principal Name (UPN)</label>
                                                <input id="newUserPrincipalName" type="email" name="userPrincipalName"
                                                    required class="users-input"
                                                    placeholder="nom@carlaaoterooutlook.onmicrosoft.com" />
                                                <small class="field-hint">
                                                    It is automatically generated from the name, but you can modify it.
                                                </small>
                                                <small id="upnError" class="field-hint"></small>

                                            </div>
                                        </div>

                                        <!-- Columna dreta -->
                                        <div class="create-user-col">
                                            <div class="form-group">
                                                <label for="newUserPassword">Initial password</label>
                                                <div class="password-input-wrapper">
                                                    <input id="newUserPassword" type="password" name="password" required
                                                        minlength="8" class="users-input" autocomplete="new-password" />
                                                </div>

                                                <div class="password-meter">
                                                    <div id="passwordStrengthBar" class="password-meter-bar"></div>
                                                </div>

                                                <small id="passwordStrengthText" class="password-hint">
                                                    The password must include uppercase letters, lowercase letters,
                                                    numbers, and be at least 8 characters long.
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="create-user-actions">
                                        <button id="createUserBtn" type="submit" class="btn btn-primary"
                                            aria-disabled="true">
                                            Create user
                                        </button>

                                    </div>
                                </div>
                            </form>
                        </article>

                        <!-- <!-- Llista completa d'usuaris -->
                        <form method="POST" action="/tenant/users/delete" data-confirm="true"
                            data-confirm-title="<%= UI_MESSAGES.MODAL.CONFIRM_TITLE %>"
                            data-confirm-message="<%= UI_MESSAGES.MODAL.CONFIRM_DELETE_MESSAGE %>"
                            data-confirm-ok="<%= UI_MESSAGES.MODAL.OK %>"
                            data-confirm-cancel="<%= UI_MESSAGES.MODAL.CANCEL %>">

                            <article class="card users-card">
                                <div class="users-card-header">
                                    <div class="users-header-left">
                                        <h2>User list</h2>
                                        <p class="users-meta">
                                            <span class="users-meta-count">
                                                <%= users && users.length ? users.length : 0 %>
                                            </span> users found
                                        </p>
                                    </div>

                                    <div class="users-header-right">
                                        <div class="users-filters">
                                            <input id="userSearch" type="text" class="users-search-input"
                                                placeholder="Search by name or UPN"
                                                onkeydown="if (event.key === 'Enter') { event.preventDefault(); }" />

                                            <select id="userTypeFilter" class="users-type-filter">
                                                <option value="all">All types</option>
                                                <option value="member">Members</option>
                                                <option value="guest">Guests</option>
                                            </select>
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            Delete selected
                                        </button>
                                    </div>
                                </div>

                                <div class="users-card-body">
                                    <% if (users && users.length> 0) { %>
                                        <table class="users-table">
                                            <thead>
                                                <tr>
                                                    <th>Display Name</th>
                                                    <th>User Principal Name</th>
                                                    <th>User Type</th>
                                                    <th>Status</th>
                                                    <th>Select</th>
                                                </tr>
                                            </thead>

                                            <tbody>
                                                <% users.forEach(function (u) { %>
                                                    <tr data-display-name="<%= u.displayName || '' %>"
                                                        data-upn="<%= u.userPrincipalName || '' %>"
                                                        data-type="<%= (u.userType || '').toLowerCase() %>">
                                                        <td>
                                                            <a href="/tenant/users/<%= encodeURIComponent(u.id) %>"
                                                                class="users-link">
                                                                <%= u.displayName || '(Unnamed)' %>
                                                            </a>
                                                        </td>

                                                        <td>
                                                            <%= u.userPrincipalName || '' %>
                                                        </td>
                                                        <td>
                                                            <%= u.userType || '—' %>
                                                        </td>

                                                        <td>
                                                            <span
                                                                class="badge <%= u.accountEnabled ? 'badge-ok' : 'badge-disabled' %>">
                                                                <%= u.accountEnabled ? 'Enabled' : 'Disabled' %>
                                                            </span>
                                                        </td>

                                                        <td class="users-select-cell">
                                                            <input type="checkbox" name="userIds" value="<%= u.id %>" />
                                                        </td>
                                                    </tr>
                                                    <% }); %>
                                            </tbody>
                                        </table>
                                        <% } else { %>
                                            <p class="users-empty">
                                                No users were found or the information could not be retrieved.
                                            </p>
                                            <% } %>
                                </div>
                            </article>
                        </form>

            </section>
        </main>

        <!-- JS: filtres + creació d'usuari -->
        <script>
            (function () {
                // --- Filtres de la taula principal ---
                const searchInput = document.getElementById('userSearch');
                const typeFilter = document.getElementById('userTypeFilter');
                const rows = Array.from(document.querySelectorAll('.users-table tbody tr'));
                const countSpan = document.querySelector('.users-meta-count');

                function applyUserFilters() {
                    const term = (searchInput && searchInput.value || '').trim().toLowerCase();
                    const type = (typeFilter && typeFilter.value || 'all').toLowerCase();

                    let visibleCount = 0;

                    rows.forEach(row => {
                        const dn = (row.dataset.displayName || '').toLowerCase();
                        const upn = (row.dataset.upn || '').toLowerCase();
                        const userType = (row.dataset.type || '').toLowerCase();

                        const matchesText = !term || dn.includes(term) || upn.includes(term);
                        const matchesType = type === 'all' || userType === type;

                        const visible = matchesText && matchesType;
                        row.style.display = visible ? '' : 'none';
                        if (visible) visibleCount++;
                    });

                    if (countSpan) countSpan.textContent = visibleCount;
                }

                if (searchInput) searchInput.addEventListener('input', applyUserFilters);
                if (typeFilter) typeFilter.addEventListener('change', applyUserFilters);


                applyUserFilters();

                // --- Crear usuari: auto-UPN i força de contrasenya ---
                const createUserForm = document.getElementById('createUserForm');
                const displayNameInput = document.getElementById('newDisplayName');
                const upnInput = document.getElementById('newUserPrincipalName');
                const passwordInput = document.getElementById('newUserPassword');
                const strengthBar = document.getElementById('passwordStrengthBar');
                const strengthText = document.getElementById('passwordStrengthText');
                const createBtn = document.getElementById('createUserBtn');
                const displayNameError = document.getElementById('displayNameError');
                const upnError = document.getElementById('upnError');

                if (createUserForm) createUserForm.setAttribute('novalidate', 'novalidate');

                const UPN_DOMAIN = 'carlaaoterooutlook.onmicrosoft.com';
                let upnTouched = false;
                let passwordStrong = false;

                function clearCreateUserErrors() {
                    if (displayNameError) {
                        displayNameError.textContent = '';
                        displayNameError.classList.remove('error');
                    }
                    if (upnError) {
                        upnError.textContent = '';
                        upnError.classList.remove('error');
                    }
                    if (strengthText) strengthText.classList.remove('error');
                }

                function showDisplayNameError(msg) {
                    if (!displayNameError) return;
                    displayNameError.textContent = msg;
                    displayNameError.classList.add('error');
                }

                function showUpnError(msg) {
                    if (!upnError) return;
                    upnError.textContent = msg;
                    upnError.classList.add('error');
                }

                function showPasswordError(msg) {
                    if (!strengthText) return;
                    strengthText.textContent = msg;
                    strengthText.classList.add('error');
                }

                function setCreateButtonEnabled(enabled) {
                    if (!createBtn) return;
                    createBtn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
                    createBtn.style.opacity = enabled ? '1' : '0.6';
                    createBtn.style.cursor = enabled ? 'pointer' : 'not-allowed';
                }

                function isCreateFormValid() {
                    const dn = (displayNameInput && displayNameInput.value || '').trim();
                    const upn = (upnInput && upnInput.value || '').trim();
                    const pw = (passwordInput && passwordInput.value || '').trim();
                    return Boolean(dn && upn && pw && passwordStrong);
                }

                function updateCreateButtonState() {
                    setCreateButtonEnabled(isCreateFormValid());
                }

                function slugifyName(name) {
                    return (name || '')
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        .toLowerCase()
                        .trim()
                        .replace(/\s+/g, '.')
                        .replace(/[^a-z0-9.]/g, '');
                }

                function updateUPNFromDisplayName() {
                    if (!displayNameInput || !upnInput || upnTouched) return;
                    const base = slugifyName(displayNameInput.value);
                    upnInput.value = base ? `${base}@${UPN_DOMAIN}` : '';
                }

                if (upnInput) {
                    upnInput.addEventListener('input', () => {
                        upnTouched = true;
                        clearCreateUserErrors();
                        updateCreateButtonState();
                    });
                }

                if (displayNameInput) {
                    displayNameInput.addEventListener('input', () => {
                        updateUPNFromDisplayName();
                        clearCreateUserErrors();
                        updateCreateButtonState();
                    });
                    displayNameInput.addEventListener('blur', updateUPNFromDisplayName);
                }

                function evaluatePasswordStrength(pwd) {
                    if (!strengthBar || !strengthText) return;

                    const rootStyles = getComputedStyle(document.documentElement);
                    const themeGrey = rootStyles.getPropertyValue('--color2') || '#504845';
                    const themeBlue = rootStyles.getPropertyValue('--color3') || '#6789a6';

                    strengthBar.className = 'password-meter-bar';
                    strengthBar.style.width = '0%';
                    strengthBar.style.backgroundColor = 'transparent';

                    passwordStrong = false;

                    if (!pwd) {
                        strengthText.textContent = 'The password must include uppercase letters, lowercase letters, numbers, and be at least 8 characters long.';
                        updateCreateButtonState();
                        return;
                    }

                    const lengthOK = pwd.length >= 8;
                    const hasLower = /[a-z]/.test(pwd);
                    const hasUpper = /[A-Z]/.test(pwd);
                    const hasDigit = /\d/.test(pwd);
                    const hasSpecial = /[^A-Za-z0-9]/.test(pwd);
                    const categories = [hasLower, hasUpper, hasDigit, hasSpecial].filter(Boolean).length;

                    if (!lengthOK || categories <= 1) {
                        strengthBar.style.width = '33%';
                        strengthBar.style.backgroundColor = '#ef4444';
                        strengthText.textContent = 'Too weak. Add more length and character variety.';
                        passwordStrong = false;
                    } else if (categories === 2) {
                        strengthBar.style.width = '66%';
                        strengthBar.style.backgroundColor = themeGrey;
                        strengthText.textContent = 'Acceptable, but it is recommended to add more character categories.';
                        passwordStrong = false;
                    } else {
                        strengthBar.style.width = '100%';
                        strengthBar.style.backgroundColor = themeBlue;
                        strengthText.textContent = 'Strong password, compliant with complexity policies.';
                        passwordStrong = true;
                    }

                    updateCreateButtonState();
                }

                if (passwordInput) {
                    passwordInput.addEventListener('input', (e) => {
                        clearCreateUserErrors();
                        evaluatePasswordStrength(e.target.value || '');
                    });
                    evaluatePasswordStrength('');
                }

                if (createBtn) {
                    createBtn.addEventListener('click', (e) => {
                        const isAriaDisabled = createBtn.getAttribute('aria-disabled') === 'true';
                        if (!isAriaDisabled) return;

                        e.preventDefault();
                        clearCreateUserErrors();

                        const dn = (displayNameInput && displayNameInput.value || '').trim();
                        const upn = (upnInput && upnInput.value || '').trim();
                        const pw = (passwordInput && passwordInput.value || '').trim();

                        if (!dn) { showDisplayNameError("You must fill in the Display Name."); displayNameInput && displayNameInput.focus(); return; }
                        if (!upn) { showUpnError("You must fill in the UPN."); upnInput && upnInput.focus(); return; }
                        if (!pw) { showPasswordError("You must fill in the initial password."); passwordInput && passwordInput.focus(); return; }
                        if (!passwordStrong) { showPasswordError("The password does not meet the minimum requirements."); passwordInput && passwordInput.focus(); return; }

                        showPasswordError("You must fill in all fields and provide a strong password.");
                    });
                }

                if (createUserForm) {
                    createUserForm.addEventListener('submit', (e) => {
                        if (!isCreateFormValid()) {
                            e.preventDefault();
                            clearCreateUserErrors();
                            showPasswordError("You must fill in all fields and provide a strong password.");
                        }
                    });
                }

                updateCreateButtonState();
            })();
        </script>

        <!-- Modal global -->
        <%- include('../components/confirmModal', { title: 'Confirmation' ,
            message: 'Are you sure you want to continue?' , okText: 'Confirm' , cancelText: 'Cancel' }) %>


            <script src="/js/confirmModal.js"></script>
            <script src="/js/navbar.js"></script>


            <footer class="footer">
                <small>&copy; <%= new Date().getFullYear() %> EntraSecure · TFG</small>
            </footer>

</body>

</html>