<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>
        <%= title %> ¬∑ EntraSecure
    </title>

    <!-- Design foundation -->
    <link rel="stylesheet" href="/css/foundation.css" />
    <!-- Utilities -->
    <link rel="stylesheet" href="/css/utilities.css" />

    <!-- Components -->
    <link rel="stylesheet" href="/css/components/navbar.css" />
    <link rel="stylesheet" href="/css/components/button.css" />
    <link rel="stylesheet" href="/css/components/card.css" />
    <link rel="stylesheet" href="/css/components/avatar.css" />
    <link rel="stylesheet" href="/css/components/confirmModal.css" />
    <link rel="stylesheet" href="/css/components/navigation.css" />


    <link rel="stylesheet" href="/css/pages/identity.css" />
    <link rel="stylesheet" href="/css/pages/tenantUsers.css" />

</head>

<body>
    <!-- Navbar -->
    <%- include('../components/navbar', { active: 'tenant' }) %>

        <main class="identity-main">
            <a href="/tenant/apps" class="back-arrow" aria-label="Tornar a Tenant Explorer">
                ‚Üê
            </a>
            <% if (flash && flash.message) { %>
                <div class="identity-flash-wrapper">
                    <div class="card flash-card">
                        <strong>
                            <%= flash.type==='error' ? 'Error' : (flash.type==='success' ? 'OK' : 'Info' ) %>:
                        </strong>
                        <span>
                            <%= flash.message %>
                        </span>
                    </div>
                </div>
                <% } %>
                    <section class="identity-layout">

                        <!-- Perfil de l'app (service principal) -->
                        <article class="card identity-profile-card">
                            <div class="identity-avatar-wrapper">
                                <div class="profile-avatar">
                                    <span>
                                        <% const appName=servicePrincipal && servicePrincipal.displayName; const
                                            initial=appName ? appName.charAt(0).toUpperCase() : 'A' ; %>
                                            <%= initial %>
                                    </span>
                                </div>
                            </div>

                            <div class="identity-profile-info">
                                <h2 class="identity-title">
                                    <%= servicePrincipal.displayName || 'Tenant application' %>
                                </h2>
                            </div>

                            <dl class="identity-details">
                                <div class="identity-detail-row">
                                    <dt>Application (client) ID</dt>
                                    <dd>
                                        <%= servicePrincipal.appId || '‚Äî' %>
                                    </dd>
                                </div>

                                <div class="identity-detail-row">
                                    <dt>Object ID</dt>
                                    <dd>
                                        <%= appRegistration && appRegistration.id ? appRegistration.id : '‚Äî' %>
                                    </dd>
                                </div>

                                <div class="identity-detail-row">
                                    <dt>Authentication protocol</dt>
                                    <dd>
                                        <%= authProtocolLabel || '‚Äî' %>
                                    </dd>
                                </div>

                                <div class="identity-detail-row">
                                    <dt>Created date time</dt>
                                    <dd>
                                        <%= servicePrincipal.createdDateTime || '‚Äî' %>
                                    </dd>
                                </div>
                            </dl>
                        </article>

                        <!-- Owners -->
                        <article class="card identity-card identity-groups-card">
                            <h3>Owners</h3>
                            <div class="identity-card-content">

                                <!-- Formulari per afegir owners amb desplegable -->
                                <form id="addAppOwnersForm" method="POST"
                                    action="/tenant/apps/<%= encodeURIComponent(servicePrincipal.id) %>/owners/add"
                                    class="identity-inline-form">

                                    <label for="appOwnersInput" class="identity-inline-label">
                                        Add owners to the application
                                    </label>

                                    <div class="identity-inline-input">
                                        <input id="appOwnersInput" type="text" class="users-input"
                                            placeholder="Search by name or UPN, or enter a UPN and press Enter"
                                            autocomplete="off" />

                                        <!-- Dropdown amb usuaris -->
                                        <div id="appOwnersDropdown" class="owners-dropdown" style="display:none;"></div>
                                    </div>

                                    <small class="field-hint">
                                        Select users from the dropdown or enter UPNs manually.
                                    </small>

                                    <!-- Chips -->
                                    <div id="appOwnersChips" class="owners-chip-list"></div>

                                    <!-- Hidden que enviarem al POST -->
                                    <input type="hidden" name="ownerKeys" id="appOwnersHidden" />

                                    <div class="identity-inline-actions">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            Add selected owners
                                        </button>
                                    </div>
                                </form>

                                <% if (owners && owners.length> 0) { %>
                                    <div class="identity-item-list">
                                        <% owners.forEach(function(o) { %>
                                            <div class="identity-item-card identity-removable">

                                                <!-- BOT√ì ELIMINAR (creu) -->
                                                <form method="POST"
                                                    action="/tenant/apps/<%= encodeURIComponent(servicePrincipal.id) %>/owners/<%= encodeURIComponent(o.id) %>/remove"
                                                    class="remove-form" data-confirm="true"
                                                    data-confirm-title="<%= UI_MESSAGES.MODAL.CONFIRM_TITLE %>"
                                                    data-confirm-message="Do you want to remove ¬´<%= (o.displayName || o.userPrincipalName || 'aquest usuari') %>¬ª as an owner of the application?"
                                                    data-confirm-ok="<%= UI_MESSAGES.MODAL.OK %>"
                                                    data-confirm-cancel="<%= UI_MESSAGES.MODAL.CANCEL %>">
                                                    <button type="submit" class="remove-btn">√ó</button>
                                                </form>


                                                <div class="identity-item-title">
                                                    <% if (o.id) { %>
                                                        <a href="/tenant/users/<%= encodeURIComponent(o.id) %>"
                                                            class="identity-link">
                                                            <%= o.displayName || o.userPrincipalName || '(Unnamed)' %>
                                                        </a>
                                                        <% } else { %>
                                                            <%= o.displayName || o.userPrincipalName || '(Unnamed)' %>
                                                                <% } %>
                                                </div>

                                                <div class="identity-item-meta">
                                                    <%= o.userPrincipalName || '' %>
                                                        <% if (o.userType) { %> ¬∑ <%= o.userType %>
                                                                <% } %>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                    <% } else { %>
                                        <p class="identity-empty">
                                            This application has no owners, or the information could not be retrieved.
                                        </p>
                                        <% } %>

                            </div>
                        </article>


                        <!-- Usuaris amb acc√©s a l'app -->
                        <!-- Usuaris amb acc√©s a l'app -->
                        <article class="card identity-card identity-roles-card">
                            <h3>Users</h3>
                            <div class="identity-card-content">

                                <!-- Formulari per afegir assignacions (users/groups) -->
                                <form id="addAppAssignmentsForm" method="POST"
                                    action="/tenant/apps/<%= encodeURIComponent(servicePrincipal.id) %>/assignments/add"
                                    class="identity-inline-form">

                                    <label for="appAssignmentsInput" class="identity-inline-label">
                                        Assign users to the application
                                    </label>

                                    <div class="identity-inline-input">
                                        <input id="appAssignmentsInput" type="text" class="users-input"
                                            placeholder="Search by name or UPN, or enter a UPN and press Enter"
                                            autocomplete="off" />

                                        <div id="appAssignmentsDropdown" class="owners-dropdown" style="display:none;">
                                        </div>
                                    </div>

                                    <small class="field-hint">
                                        This action creates an assignment (default app role) to the Enterprise App.
                                    </small>

                                    <div id="appAssignmentsChips" class="owners-chip-list"></div>

                                    <input type="hidden" name="assignmentKeys" id="appAssignmentsHidden" />

                                    <div class="identity-inline-actions">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            Assign selected
                                        </button>
                                    </div>
                                </form>

                                <% if (assignments && assignments.length> 0) { %>
                                    <div class="identity-item-list">
                                        <% assignments.forEach(function(a) { %>
                                            <div class="identity-item-card identity-removable">

                                                <!-- BOT√ì ELIMINAR assignaci√≥ (creu) -->
                                                <form method="POST"
                                                    action="/tenant/apps/<%= encodeURIComponent(servicePrincipal.id) %>/assignments/<%= encodeURIComponent(a.id) %>/remove"
                                                    class="remove-form" data-confirm="true"
                                                    data-confirm-title="<%= UI_MESSAGES.MODAL.CONFIRM_TITLE %>"
                                                    data-confirm-message="Do you want to remove the assignment for ¬´<%= (a.principalDisplayName || 'aquest element') %>¬ª?"
                                                    data-confirm-ok="<%= UI_MESSAGES.MODAL.OK %>"
                                                    data-confirm-cancel="<%= UI_MESSAGES.MODAL.CANCEL %>">
                                                    <button type="submit" class="remove-btn">√ó</button>
                                                </form>


                                                <div class="identity-item-title">
                                                    <%= a.principalDisplayName || '(Unnamed)' %>
                                                </div>

                                                <div class="identity-item-meta">
                                                    <%= a.principalType || '' %>
                                                        <% if (a.appRoleId) { %> ¬∑ AppRoleId: <%= a.appRoleId %>
                                                                <% } %>
                                                </div>

                                            </div>
                                            <% }); %>
                                    </div>
                                    <% } else { %>
                                        <p class="identity-empty">
                                            This application has no users or groups directly assigned (or the
                                            information could not be retrieved).
                                        </p>
                                        <% } %>

                            </div>
                        </article>



                        <!-- Permisos (appRoles + requiredResourceAccess) -->
                        <article class="card identity-card identity-apps-card">
                            <h3>Permissions</h3>
                            <div class="identity-card-content">
                                <% if (appRegistration || (resolvedPermissions && resolvedPermissions.length> 0)) { %>
                                    <div class="identity-item-list">

                                        <% // (Opcional) App roles que l'aplicaci√≥ exposa a altres apps %>
                                            <% if (appRegistration && appRegistration.appRoles &&
                                                appRegistration.appRoles.length>
                                                0) { %>
                                                <div class="identity-item-card">
                                                    <div class="identity-item-title">App roles defined by this
                                                        application</div>
                                                    <div class="identity-item-meta">
                                                        <ul>
                                                            <% appRegistration.appRoles.forEach(function(r) { %>
                                                                <li>
                                                                    <strong>
                                                                        <%= r.displayName || '(Unnamed)' %>
                                                                    </strong>
                                                                    (<%= r.value || 'no value' %>)
                                                                </li>
                                                                <% }); %>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <% // üîπ Una card per a cada perm√≠s d'API (Graph, etc.) %>
                                                        <% if (resolvedPermissions && resolvedPermissions.length> 0) {
                                                            %>
                                                            <% resolvedPermissions.forEach(function(api) { %>
                                                                <% api.permissions.forEach(function(p) { %>
                                                                    <div class="identity-item-card">
                                                                        <div class="identity-item-title">
                                                                            <%= p.name %>
                                                                                <span class="identity-tag">
                                                                                    <%= p.type %> permission
                                                                                </span>
                                                                        </div>
                                                                        <div class="identity-item-meta">
                                                                            <p>
                                                                                <strong>API:</strong>
                                                                                <%= api.apiDisplayName %> (<%=
                                                                                        api.apiAppId %>)
                                                                            </p>
                                                                            <p>
                                                                                <% if (p.displayName) { %>
                                                                                    <%= p.displayName %>
                                                                                        <% } else { %>
                                                                                            Description not available
                                                                                            from Microsoft Graph.
                                                                                            <% } %>
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                    <% }); %>
                                                                        <% }); %>
                                                                            <% } else { %>
                                                                                <p class="identity-empty">
                                                                                    This application has no API
                                                                                    permissions configured, or they
                                                                                    could not be retrieved.
                                                                                </p>
                                                                                <% } %>

                                    </div>
                                    <% } else { %>
                                        <p class="identity-empty">
                                            This Enterprise app has no app registration associated in the tenant (it is
                                            likely a Microsoft or external application).
                                        </p>
                                        <% } %>
                            </div>
                        </article>


                        <!-- Credencials (secrets, certificats, federated) -->
                        <article class="card identity-card identity-devices-card">
                            <h3>Application credentials</h3>
                            <div class="identity-card-content">
                                <% if (appRegistration && ( (appRegistration.passwordCredentials &&
                                    appRegistration.passwordCredentials.length) || (appRegistration.keyCredentials &&
                                    appRegistration.keyCredentials.length) || (federatedCreds && federatedCreds.length)
                                    )) { %>
                                    <div class="identity-item-list">
                                        <% if (appRegistration.passwordCredentials &&
                                            appRegistration.passwordCredentials.length> 0)
                                            { %>
                                            <div class="identity-item-card">
                                                <div class="identity-item-title">Client secrets</div>
                                                <div class="identity-item-meta">
                                                    <ul>
                                                        <% appRegistration.passwordCredentials.forEach(function(pw) { %>
                                                            <li>
                                                                ID: <%= pw.keyId %> ¬∑ Expira: <%= pw.endDateTime || '‚Äî'
                                                                        %>
                                                            </li>
                                                            <% }); %>
                                                    </ul>
                                                </div>
                                            </div>
                                            <% } %>

                                                <% if (appRegistration.keyCredentials &&
                                                    appRegistration.keyCredentials.length> 0) {
                                                    %>
                                                    <div class="identity-item-card">
                                                        <div class="identity-item-title">Certificates</div>
                                                        <div class="identity-item-meta">
                                                            <ul>
                                                                <% appRegistration.keyCredentials.forEach(function(k) {
                                                                    %>
                                                                    <li>
                                                                        ID: <%= k.keyId %> ¬∑ Expires: <%= k.endDateTime
                                                                                || '‚Äî' %>
                                                                    </li>
                                                                    <% }); %>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <% } %>

                                                        <% if (federatedCreds && federatedCreds.length> 0) { %>
                                                            <div class="identity-item-card">
                                                                <div class="identity-item-title">Federated credentials
                                                                </div>
                                                                <div class="identity-item-meta">
                                                                    <ul>
                                                                        <% federatedCreds.forEach(function(fc) { %>
                                                                            <li>
                                                                                <%= fc.name %> ¬∑ issuer: <%= fc.issuer
                                                                                        || '‚Äî' %>
                                                                            </li>
                                                                            <% }); %>
                                                                    </ul>
                                                                </div>
                                                            </div>
                                                            <% } %>
                                    </div>
                                    <% } else { %>
                                        <p class="identity-empty">
                                            No associated secrets, certificates, or federated credentials were found (or
                                            the information could not be retrieved).
                                        </p>
                                        <% } %>
                            </div>
                        </article>

                        <!-- Card educativa -->
                        <article class="card identity-card identity-edu-card">
                            <h3>How to read this information</h3>
                            <div class="identity-card-content">
                                <p class="identity-edu">
                                    <%= helpfulInfo %>
                                </p>
                            </div>
                        </article>

                    </section>
        </main>

        <script>
            (function () {
                // Usuaris del tenant injectats des del servidor
                const allUsers = <%- JSON.stringify(users || []) %>;

                // Helper com√∫ per muntar un selector amb desplegable + chips
                function setupUserSelector(config) {
                    const { inputId, dropdownId, chipsId, hiddenId } = config;

                    const input = document.getElementById(inputId);
                    const dropdown = document.getElementById(dropdownId);
                    const chips = document.getElementById(chipsId);
                    const hidden = document.getElementById(hiddenId);

                    const selected = [];

                    function updateHidden() {
                        if (hidden) hidden.value = selected.join(',');
                    }

                    function renderChips() {
                        if (!chips) return;
                        chips.innerHTML = '';

                        selected.forEach((upn, index) => {
                            const chip = document.createElement('span');
                            chip.className = 'owner-chip';
                            chip.textContent = upn + ' ';

                            const closeBtn = document.createElement('button');
                            closeBtn.type = 'button';
                            closeBtn.className = 'owner-chip-remove';
                            closeBtn.textContent = '√ó';

                            closeBtn.addEventListener('click', () => {
                                selected.splice(index, 1);
                                updateHidden();
                                renderChips();
                            });

                            chip.appendChild(closeBtn);
                            chips.appendChild(chip);
                        });
                    }

                    function buildDropdown() {
                        if (!dropdown) return;
                        dropdown.innerHTML = '';

                        const header = document.createElement('div');
                        header.className = 'owners-dropdown-header';

                        const searchBox = document.createElement('input');
                        searchBox.type = 'text';
                        searchBox.placeholder = 'Cerca per nom o UPN';
                        searchBox.className = 'users-input owners-search-input';

                        const addBtn = document.createElement('button');
                        addBtn.type = 'button';
                        addBtn.textContent = 'Afegir seleccionats';
                        addBtn.className = 'btn btn-primary owners-add-btn';

                        header.appendChild(searchBox);
                        header.appendChild(addBtn);

                        const list = document.createElement('div');
                        list.className = 'owners-dropdown-list';

                        dropdown.appendChild(header);
                        dropdown.appendChild(list);

                        function renderList(filterTerm = '') {
                            const term = (filterTerm || '').trim().toLowerCase();
                            list.innerHTML = '';

                            const filtered = (allUsers || []).filter(u => {
                                const dn = (u.displayName || '').toLowerCase();
                                const upn = (u.userPrincipalName || '').toLowerCase();
                                if (!term) return true;
                                return dn.includes(term) || upn.includes(term);
                            });

                            filtered.forEach(u => {
                                const option = document.createElement('label');
                                option.className = 'owner-option';

                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'owner-option-checkbox';
                                checkbox.value = u.userPrincipalName || '';

                                const info = document.createElement('div');
                                info.className = 'owner-option-info';
                                info.innerHTML = `
              <span class="owner-option-name">${u.displayName || '(Unnamed)'}</span>
              <span class="owner-option-upn">${u.userPrincipalName || ''}</span>
              <span class="owner-option-type">${u.userType || ''}</span>
            `;

                                option.appendChild(checkbox);
                                option.appendChild(info);
                                list.appendChild(option);
                            });
                        }

                        renderList('');

                        searchBox.addEventListener('input', (e) => {
                            renderList(e.target.value || '');
                        });

                        addBtn.addEventListener('click', () => {
                            const checked = list.querySelectorAll('.owner-option-checkbox:checked');
                            checked.forEach(cb => {
                                const upn = cb.value;
                                if (upn && !selected.includes(upn)) selected.push(upn);
                            });

                            updateHidden();
                            renderChips();

                            checked.forEach(cb => cb.checked = false);
                        });
                    }

                    // Obrir/tancar desplegable
                    if (input && dropdown) {
                        input.addEventListener('focus', () => {
                            if (dropdown.children.length === 0) buildDropdown();
                            dropdown.style.display = 'block';
                        });

                        document.addEventListener('click', (e) => {
                            if (input.contains(e.target) || dropdown.contains(e.target)) return;
                            dropdown.style.display = 'none';
                        });
                    }

                    // Afegir UPN manualment amb Enter
                    if (input) {
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const value = input.value.trim();
                                if (!value) return;

                                value.split(',')
                                    .map(v => v.trim())
                                    .filter(Boolean)
                                    .forEach(v => {
                                        if (!selected.includes(v)) selected.push(v);
                                    });

                                updateHidden();
                                renderChips();
                                input.value = '';
                            }
                        });
                    }

                    function flushInput() {
                        if (!input) return;
                        const value = input.value.trim();
                        if (!value) return;

                        value.split(',')
                            .map(v => v.trim())
                            .filter(Boolean)
                            .forEach(v => {
                                if (!selected.includes(v)) selected.push(v);
                            });

                        updateHidden();
                        renderChips();
                        input.value = '';
                    }

                    return { flushInput };
                }

                // Instanciem 2 selectors: Owners i Assignments
                const ownersSelector = setupUserSelector({
                    inputId: 'appOwnersInput',
                    dropdownId: 'appOwnersDropdown',
                    chipsId: 'appOwnersChips',
                    hiddenId: 'appOwnersHidden',
                });

                const assignmentsSelector = setupUserSelector({
                    inputId: 'appAssignmentsInput',
                    dropdownId: 'appAssignmentsDropdown',
                    chipsId: 'appAssignmentsChips',
                    hiddenId: 'appAssignmentsHidden',
                });

                // Flush en submit (igual que grups)
                const addOwnersForm = document.getElementById('addAppOwnersForm');
                const addAssignmentsForm = document.getElementById('addAppAssignmentsForm');

                if (addOwnersForm && ownersSelector) {
                    addOwnersForm.addEventListener('submit', () => ownersSelector.flushInput());
                }

                if (addAssignmentsForm && assignmentsSelector) {
                    addAssignmentsForm.addEventListener('submit', () => assignmentsSelector.flushInput());
                }
            })();
        </script>


        <!-- Modal global -->
        <%- include('../components/confirmModal', { title: 'Confirmation' ,
            message: 'Are you sure you want to continue?' , okText: 'Confirm' , cancelText: 'Cancel' }) %>

            <script src="/js/confirmModal.js"></script>
            <script src="/js/navbar.js"></script>

            <footer class="footer">
                <small>&copy; <%= new Date().getFullYear() %> EntraSecure ¬∑ TFG</small>
            </footer>
</body>

</html>